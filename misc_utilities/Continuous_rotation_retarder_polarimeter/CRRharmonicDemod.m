function [M,A,A2] = CRRharmonicDemod(f0,f1,p0,p1,d0,d1,I,t)
% very inefficnet way of doing the complex demodulation. also, there
% appears to be a mistake in here that I don't care to find.
R = complex(zeros(12,12),zeros(12,12));
B = complex(zeros(12,1),zeros(12,1));
A2 = B;
M = zeros(4);
a = sin(d0);
b = sin(d1);
c = (1+cos(d0))/2;
d = -(1+cos(d1))/2;
e = (1-cos(d0))/2;
f = (cos(d1)-1)/2;

R(1,1) = 1/2;
R(1,4) = -c/e;
R(1,5) = -d/f;
R(1,11) = c*d/(e*f);
R(1,12) = c*d/(e*f);
R(2,4) = 1/e;
R(2,11) = -d/(e*f);
R(2,12) = -d/(e*f);
R(3,2) = 1/a;
R(3,7) = -d/(a*f);
R(3,8) = -d/(a*f);
R(4,5) = 1/f;
R(4,11) = -c/(e*f);
R(4,12) = -c/(e*f);
R(5,11) = 1/(e*f);
R(5,12) = 1/(e*f);
R(6,7) = 1/(a*f);
R(6,8) = 1/(a*f);
R(7,5) = 1/f;
R(7,11) = -c/(e*f);
R(7,12) = c/(e*f);
R(8,11) = -1/(e*f);
R(8,12) = 1/(e*f);
R(9,7) = -1/(a*f);
R(9,8) = 1/(a*f);
R(10,3) = 1/b;
R(10,9) = -c/(b*e);
R(10,10) = c/(b*e);
R(11,9) = -1/(b*e);
R(11,9) = 1/(b*e);
R(12,6) = 2/(a*b);
for index=1:length(t)-1
arg0 = 2*(2*pi*f0.*t(index) + p0);
arg1 = 2*(2*pi*f1.*t(index) + p1);
B(1) = 1;
B(2) = exp(1i*arg0);
B(3) = exp(1i*arg1);
B(4) = exp(2*1i*arg0);
B(5) = exp(2*1i*arg1);
B(6) = exp(1i*(arg0-arg1));
B(7) = exp(1i*(arg0+2*arg1));
B(8) = exp(1i*(arg0-2*arg1));
B(9) = exp(1i*(2*arg0+arg1));
B(10) = exp(1i*(2*arg0-arg1));
B(11) = exp(1i*2*(arg0+arg1));
B(12) = exp(1i*2*(arg0-arg1));
A2 = I(index).*B + A2;
end
A = R*A2;
M(1,1) = real(A(1));
M(1,2) = real(A(2));
M(1,3) = imag(A(2));
M(1,4) = imag(A(3));
M(2,1) = real(A(4));
M(2,2) = real(A(5));
M(2,3) = imag(A(5));
M(2,4) = imag(A(6));
M(3,1) = imag(A(7));
M(3,2) = imag(A(8));
M(3,3) = -real(A(8));
M(3,4) = real(A(9));
M(4,1) = real(A(10));
M(4,2) = imag(A(11));
M(4,3) = -real(A(11));
M(4,4) = real(A(12));
M = M./(length(t)-1)*2;
end